# yamllint disable rule:truthy
---
name: Collection CI

on:
  # CI on pushes to main and version tags (v*)
  push:
    branches: ["main"]
    tags: ["v*"]
  # CI on all PRs
  pull_request:

permissions:
  contents: read

env:
  # Common tool versions (override if needed)
  PYTHON_VERSION: "3.11"
  ANSIBLE_CORE_VERSION: "2.18.13"
  ANSIBLE_LINT_VERSION: "6.22.2"
  TERRAFORM_VERSION: "1.14.5"
  COLLECTION_NAMESPACE: lit

  # Example playbook that MUST exist in this repository.
  EXAMPLE_PLAYBOOK: "playbooks/example.yml"

jobs:
  validate-certified-requirements:
    name: Validate certified requirements on Automation Hub
    runs-on: ubuntu-latest
    env:
      AUTOMATION_HUB_TOKEN: ${{ secrets.RH_AUTOMATION_HUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect certified requirements file
        id: certified_requirements
        run: |
          if [[ -f collections/requirements-certified.yml ]]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip when no certified requirements file exists
        if: ${{ steps.certified_requirements.outputs.present == 'false' }}
        run: |
          echo "No collections/requirements-certified.yml found; skipping Automation Hub validation."

      - name: Require Automation Hub token
        if: ${{ steps.certified_requirements.outputs.present == 'true' && env.AUTOMATION_HUB_TOKEN == '' }}
        run: |
          echo "RH_AUTOMATION_HUB_TOKEN is required for certified requirements validation." >&2
          exit 1

      - name: Sync certified collection versions from Automation Hub
        if: ${{ steps.certified_requirements.outputs.present == 'true' && env.AUTOMATION_HUB_TOKEN != '' }}
        run: |
          bash scripts/sync-certified-from-ah.sh collections/requirements-certified.yml

      - name: Show synced certified requirements
        if: ${{ steps.certified_requirements.outputs.present == 'true' && env.AUTOMATION_HUB_TOKEN != '' }}
        run: |
          cat collections/requirements-certified.yml

      - name: Validate certified collection versions
        if: ${{ steps.certified_requirements.outputs.present == 'true' && env.AUTOMATION_HUB_TOKEN != '' }}
        run: |
          bash scripts/validate-certified-on-ah.sh collections/requirements-certified.yml

  # ---------------------------------------------------------------------------
  # Collection CI
  # ---------------------------------------------------------------------------
  lint:
    name: Lint (ansible-lint via ee-wunder-devtools-ubi9)
    runs-on: ubuntu-latest
    needs: validate-certified-requirements

    steps:
      # 1) Checkout the repository
      - name: Checkout
        uses: actions/checkout@v6

      # 2) Run ansible-lint inside the ee-wunder-devtools-ubi9 container
      - name: Run ansible-lint via devtools-ansible-lint.sh
        env:
          # These env vars make the script generic across collections
          COLLECTION_NAMESPACE: ${{ env.COLLECTION_NAMESPACE }}
          ANSIBLE_CORE_VERSION: ${{ env.ANSIBLE_CORE_VERSION }}
          ANSIBLE_LINT_VERSION: ${{ env.ANSIBLE_LINT_VERSION }}
        run: |
          bash scripts/devtools-ansible-lint.sh

  molecule:
    name: Molecule (via devtools)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Run Molecule via ee-wunder-devtools-ubi9.
      # scripts/devtools-molecule.sh is expected to:
      #  - build the collection
      #  - install it into a temp path
      #  - run one or more molecule scenarios
      - name: Run Molecule tests (via devtools)
        env:
          MOLECULE_NO_LOG: "false"
        run: |
          bash scripts/devtools-molecule.sh

  build-install:
    name: Build & install collection (via devtools smoke test)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Run a full collection smoke test inside ee-wunder-devtools-ubi9:
      #  - build the collection
      #  - install it into /tmp/wunder/collections
      #  - run the example playbook
      - name: Run collection smoke test via devtools-collection-smoke.sh
        env:
          COLLECTION_NAMESPACE: ${{ env.COLLECTION_NAMESPACE }}
          EXAMPLE_PLAYBOOK: ${{ env.EXAMPLE_PLAYBOOK }}
        run: |
          bash scripts/devtools-collection-smoke.sh
