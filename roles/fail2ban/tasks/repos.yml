---
- name: Determine EL major version
  ansible.builtin.set_fact:
    el_major: "{{ ansible_facts.distribution_major_version | int }}"
    epel_base_url: "https://dl.fedoraproject.org/pub/epel"

- name: Build EPEL URLs
  ansible.builtin.set_fact:
    epel_release_url: >-
      {{ epel_base_url }}/epel-release-latest-{{ el_major }}.noarch.rpm
    epel_gpg_key_url: >-
      {{ epel_base_url }}/RPM-GPG-KEY-EPEL-{{ el_major }}

- name: Debug EPEL settings (optional)
  ansible.builtin.debug:
    msg:
      - "el_major={{ el_major }}"
      - "epel_release_url={{ epel_release_url }}"
      - "epel_gpg_key_url={{ epel_gpg_key_url }}"
  when: debug | default(false) | bool

- name: Check for subscription-manager
  ansible.builtin.stat:
    path: /usr/sbin/subscription-manager
  register: sm_bin

- name: Enable CodeReady Builder repository on RHEL 9 (if applicable)
  community.general.rhsm_repository:
    name: codeready-builder-for-rhel-9-x86_64-rpms
    state: enabled
  when:
    - sm_bin.stat.exists
    - el_major == 9

- name: Install epel-release from distribution repositories when available
  ansible.builtin.dnf:
    name: epel-release
    state: present
  register: epel_install_result
  failed_when: false

- name: Import EPEL GPG key (fallback path)
  ansible.builtin.rpm_key:
    key: "{{ epel_gpg_key_url }}"
    state: present
  when: epel_install_result is failed

- name: Enable EPEL repository from upstream URL (fallback)
  ansible.builtin.dnf:
    name: "{{ epel_release_url }}"
    state: present
  when: epel_install_result is failed
