---
- name: Check for subscription-manager presence
  ansible.builtin.stat:
    path: /usr/sbin/subscription-manager
  register: repos_sm

- name: Warn if subscription-manager is unavailable for enable/disable lists
  ansible.builtin.debug:
    msg: "subscription-manager not found; skipping enable/disable operations."
  when:
    - not repos_sm.stat.exists
    - (repos_enabled | length > 0 or repos_disabled | length > 0)

- name: Gather enabled repos
  ansible.builtin.command: subscription-manager repos --list-enabled
  register: repos_enabled_list
  changed_when: false
  failed_when: repos_enabled_list.rc != 0
  when:
    - repos_sm.stat.exists
    - (repos_enabled | length > 0) or (repos_disabled | length > 0)

- name: Set fact with currently enabled repo IDs
  ansible.builtin.set_fact:
    repos_current_enabled: >-
      {{
        repos_enabled_list.stdout_lines
        | select('match', '^Repo ID:')
        | map('regex_replace', '^Repo ID:\\s*', '')
        | list
      }}
  when:
    - repos_sm.stat.exists
    - repos_enabled_list is defined
    - repos_enabled_list.stdout_lines is defined

- name: Enable requested repos
  ansible.builtin.command: "subscription-manager repos --enable={{ item }}"
  loop: "{{ repos_enabled }}"
  when:
    - repos_sm.stat.exists
    - repos_enabled | length > 0
    - item not in (repos_current_enabled | default([]))
  changed_when: true

- name: Disable requested repos
  ansible.builtin.command: "subscription-manager repos --disable={{ item }}"
  loop: "{{ repos_disabled }}"
  when:
    - repos_sm.stat.exists
    - repos_disabled | length > 0
    - item in (repos_current_enabled | default([]))
  changed_when: true

- name: Manage custom yum repositories
  ansible.builtin.yum_repository:
    name: "{{ item.id }}"
    description: "{{ item.name | default(item.id) }}"
    baseurl: "{{ item.baseurl | default(omit) }}"
    metalink: "{{ item.metalink | default(omit) }}"
    mirrorlist: "{{ item.mirrorlist | default(omit) }}"
    gpgcheck: "{{ item.gpgcheck | default(false) }}"
    gpgkey: "{{ item.gpgkey | default(omit) }}"
    enabled: "{{ item.enabled | default(true) }}"
    state: present
  loop: "{{ repos_custom }}"
  loop_control:
    label: "{{ item.id }}"
