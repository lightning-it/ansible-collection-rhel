---
- name: Skip when disabled
  ansible.builtin.meta: end_host
  when: not (repos_enabled | bool)

# Proxy (optional)
- name: Configure DNF proxy (optional)
  community.general.ini_file:
    path: /etc/dnf/dnf.conf
    section: main
    option: proxy
    value: "{{ repos_proxy_url }}"
    mode: "0644"
  when:
    - repos_proxy_enabled | bool
    - repos_proxy_apply_to_dnf | bool
    - repos_proxy_url | length > 0

- name: Configure RHSM proxy (optional)
  community.general.ini_file:
    path: /etc/rhsm/rhsm.conf
    section: server
    option: proxy_hostname
    value: "{{ repos_proxy_url | regex_replace('^https?://', '') | regex_replace(':.*$', '') }}"
    mode: "0644"
  when:
    - repos_proxy_enabled | bool
    - repos_proxy_apply_to_rhsm | bool
    - repos_proxy_url | length > 0

# CodeReady Builder (optional, best-effort)
- name: Check if subscription-manager is present (for CodeReady enablement)
  ansible.builtin.command: "command -v subscription-manager"
  register: _sm_present
  changed_when: false
  failed_when: false
  when: repos_enable_codeready | bool

- name: Enable CodeReady Builder repo (best-effort)
  community.general.rhsm_repository:
    name: "{{ repos_codeready_repo }}"
    state: enabled
  register: _codeready
  failed_when: false
  when:
    - repos_enable_codeready | bool
    - _sm_present.rc == 0

# EPEL enablement (policy)
- name: Import EPEL GPG key
  ansible.builtin.rpm_key:
    key: "{{ repos_epel_gpg_key_url }}"
    state: present
  when:
    - repos_enable_epel | bool
    - repos_epel_gpg_key_url | length > 0

- name: Install EPEL release (rpm_url)
  ansible.builtin.package:
    name: "{{ repos_epel_rpm_url }}"
    state: present
  when:
    - repos_enable_epel | bool
    - repos_epel_method == 'rpm_url'

- name: Install EPEL release (package)
  ansible.builtin.package:
    name: "{{ repos_epel_package_name }}"
    state: present
  when:
    - repos_enable_epel | bool
    - repos_epel_method == 'package'

- name: Refresh dnf metadata (makecache)
  ansible.builtin.command: "dnf -y makecache"
  changed_when: false
  when: repos_makecache | bool
